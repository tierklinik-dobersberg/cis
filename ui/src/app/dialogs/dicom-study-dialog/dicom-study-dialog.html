<hlm-dialog-header>
  <h3 hlmDialogTitle>
    DICOM Studie vom {{ study.time | toDate | date: 'short' }}
  </h3>
  <p hlmDialogDescription class="flex flex-row gap-2">
    <span>Besitzer: </span>
    <span class="font-medium">{{ study.ownerName || 'N/A' }}</span>
    <span>Patient: </span>
    <span class="font-medium">{{ study.patientName || 'N/A' }}</span>
  </p>
</hlm-dialog-header>

<div
  class="flex flex-row items-start justify-start w-full h-full max-h-full gap-4 p-4 overflow-hidden">
  <div
    class="flex flex-col flex-grow-0 flex-shrink-0 w-32 h-full gap-2 p-2 overflow-auto border-r border-border">
    @for (series of study.series; track series.seriesUid) {
      @for (instance of series.instances; track instance.instanceUid) {
        <img
          (click)="selectedInstance.set(instance)"
          [attr.src]="instance | dicomImageUrl: { width: 100, height: 100 }"
          [class.outline]="selectedInstance() === instance"
          class="aspect-auto h-auto w-[100px] flex-shrink-0 flex-grow-0 cursor-pointer hover:outline" />
      }
    }
  </div>

  <hlm-tabs
    tab="viewer"
    class="flex h-full min-h-[500px] w-full flex-grow flex-col gap-2 p-2">
    <div class="flex flex-row justify-between">
      <hlm-tabs-list class="grid grid-cols-2">
        <button hlmTabsTrigger="viewer">Viewer</button>
        <button hlmTabsTrigger="tags">Tag List</button>
      </hlm-tabs-list>

      <button hlmBtn variant="secondary" size="icon" [brnMenuTriggerFor]="menu">
        <hlm-icon name="lucideMoreVertical" />
      </button>

      <ng-template #menu>
        <hlm-menu>
          <hlm-menu-label>
            Aktionen
          </hlm-menu-label>
          <hlm-menu-separator />

          <hlm-menu-group>
            <button hlmMenuItem>
              <hlm-icon name="lucideExternalLink" hlmMenuIcon /> 
              Im Viewer öffnen
            </button>

            <button hlmMenuItem [brnMenuTriggerFor]="downloadMenu">
              <hlm-icon name="lucideDownload" hlmMenuIcon /> 
              Download
            </button>

            <button hlmMenuItem [brnMenuTriggerFor]="shareMenu">
              <hlm-icon name="lucideShare" hlmMenuIcon /> 
              Teilen
            </button>

            <ng-template #downloadMenu>
              <hlm-sub-menu>
                <hlm-menu-label>
                  Downloaden als ..
                </hlm-menu-label>
                <hlm-menu-separator />

                <button hlmMenuItem>
                  Bild
                </button>

                <button hlmMenuItem>
                  DICOM Datei
                </button>
              </hlm-sub-menu>
            </ng-template>

            <ng-template #shareMenu>
              <hlm-sub-menu>
                <hlm-menu-label>
                  Teilen als ..
                </hlm-menu-label>
                <hlm-menu-separator />

                <button hlmMenuItem>
                  <hlm-icon name="lucideMail" hlmMenuIcon />
                  E-Mail
                </button>

                <button hlmMenuItem>
                  <hlm-icon name="lucideExernalLink" hlmMenuIcon />
                  Link
                </button>
              </hlm-sub-menu>
            </ng-template>
            
          </hlm-menu-group>
        </hlm-menu>

      </ng-template>
    </div>

    <div
      hlmTabsContent="viewer"
      class="flex-grow w-full h-full overflow-auto">
      <dicom-viewer [study]="study" [instance]="selectedInstance()" />
    </div>

    <div hlmTabsContent="tags" class="flex-grow w-full overflow-auto">
      @if (selectedInstance(); as instance) {
        <hlm-table>
          @for (tag of instance.tags | sortDicomTags; track tag.tag) {
            <hlm-trow>
              <hlm-td class="w-48">
                {{ tag.name }}
              </hlm-td>
              <hlm-td class="w-32">
                {{ tag.tag }}
              </hlm-td>
              <hlm-td class="flex-1 break-all">
                @for (value of tag.value; track value) {
                  {{ value.toJson() }}
                }
              </hlm-td>
            </hlm-trow>
          }
        </hlm-table>
      } @else {
        <span class="flex flex-row items-center justify-center h-32">
          Kein Bild ausgewählt
        </span>
      }
    </div>
  </hlm-tabs>
</div>
