<div class="flex items-center py-2 space-x-3">
  <input type="text" class="flex-grow tkd-input " placeholder="Nach Namen suchen ..." [(ngModel)]="searchText" (ngModelChange)="ds.search($event)">
  <button class="tkd-btn tkd-primary" (click)="ds.search(searchText)">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
    </svg>
    <span>Suchen</span>
  </button>
</div>

<div class="flex flex-grow p-2 bg-white rounded shadow sm:p-4 md:p-8">
  <cdk-virtual-scroll-viewport itemSize="48" class="flex-grow">
    <nz-list nzSize="small">
      <nz-list-item *cdkVirtualFor="let study of ds; trackBy: trackBy" (click)="toggleDrawer(study.studyInstanceUid)">
        <nz-list-item-meta>
          <nz-list-item-meta-title>
            <a *ngIf="!!study.vetinfCID && layout.isTabletLandscapeUp"
              [routerLink]="['/customer/view', 'vetinf', study.vetinfCID]" nz-popover [nzPopoverMouseEnterDelay]="0.5"
              (nzPopoverVisibleChange)="onPopoverChange($event, study)" [nzPopoverContent]="popoverTemplate">
              {{ study | ohifOwnerName }}</a>

            <span *ngIf="!study.vetinfCID || !layout.isTabletLandscapeUp">
              {{ study | ohifOwnerName }}
            </span>
          </nz-list-item-meta-title>

          <nz-list-item-meta-description>
            {{ study.studyDate | dxrDate }} &nbsp;|&nbsp;
            {{ study.animalName }} &nbsp;-&nbsp; {{ study.animalRace !== 'unknown' ? study.animalRace : 'N/A' }}
          </nz-list-item-meta-description>

          <ng-template #popoverTemplate>
            <div class="contact-popover">
              <h3>{{ popOverCustomer?.name }}&nbsp;{{ popOverCustomer?.firstname }}</h3>

              <span class="contact-type">Telefon:</span>
              <a *ngFor="let phone of popOverCustomer?.distinctPhoneNumbers; let last=last"
                [attr.href]="'tel:' + phone">
                {{phone}} {{ !last ? ', ' : '' }}&nbsp;
              </a>
              <span *ngIf="!popOverCustomer?.distinctPhoneNumbers">N/A</span>

              <span class="contact-type">E-Mail:</span>
              <a *ngFor="let mail of popOverCustomer?.mailAddresses; let last=last" [attr.href]="'mailto:' + mail">
                {{mail}} {{ !last ? ', ' : '' }}&nbsp;
              </a>
              <span *ngIf="!popOverCustomer?.mailAddresses">N/A</span>
            </div>
          </ng-template>
        </nz-list-item-meta>

        <nz-list-item-extra *ngIf="layout.isTabletLandscapeUp" class="flex flex-row items-center space-x-2">
          <img *ngFor="let preview of study.previews" (click)="openViewer(study, preview)" alt="preview" class="h-12 border border-transparent rounded cursor-pointer hover:opacity-80 hover:border-primary"
            [attr.src]="preview.previewUrl" />
        </nz-list-item-extra>
      </nz-list-item>
    </nz-list>
  </cdk-virtual-scroll-viewport>
</div>

<nz-drawer [nzVisible]="drawerVisible" [nzClosable]="true" nzPlacement="right" (nzOnClose)="toggleDrawer()"
  [nzWidth]="layout.drawerWidth | async">
  <ng-template [nzDrawerContent]>
    <div class="drawer-container">
      <h2>{{ drawerStudy | ohifOwnerName }}</h2>
      <h3>
        {{ drawerStudy?.animalName }} &nbsp;- &nbsp; {{ drawerStudy?.animalRace !== 'unknown' ?
        drawerStudy?.animalRace
        : 'N/A' }}
      </h3>

      <div *ngIf="!!drawerStudy?.vetinfCID" class="drawer-toolbar">
        <a nz-button [routerLink]="['/customer/view', 'vetinf', drawerStudy?.vetinfCID]">Kunden
          anzeigen</a>
      </div>

      <p>RÃ¶ntgen-Aufnahmen in dieser Studie:</p>
      <div class="previews">
        <div *ngFor="let series of drawerStudy?.seriesList">
          <h4>
            {{ series.seriesDescription }}
          </h4>

          <ol *ngIf="series?.instances?.length > 0">
            <li *ngFor="let instance of series?.instances">
              <img (click)="openViewer(drawerStudy, series, instance)" [attr.src]="instance.url | previewUrl" />
            </li>
          </ol>

          <span *ngIf="!series?.instances?.length" class="no-instances">
            <i nz-icon nzType="close" nzTheme="outline"></i>
            Keine Aufnahmen
          </span>
        </div>
      </div>
    </div>
  </ng-template>
</nz-drawer>
