<div *ngIf="today && today.actual; else: noOverwrite">
  <div class="flex flex-row items-start">
    <div class="w-14">
      <nz-avatar nzIcon="user" nzShape="circle" [nzSize]="56" class="tkd-avatar" [nzSrc]="today.actualUser?.avatar || null"></nz-avatar>
    </div>
    <div class="flex flex-col flex-grow justify-start ml-4">
      <span class="font-semibold text-primary">{{ today.actualUser?.fullname || today.actual.displayName || today.actual.phoneNumber }}</span>
      <span class="text-secondary">
        Telefon ist bis <span class="text-highlight">{{ today.actual.to | date:'medium' }}</span> umgeleitet und folgt nicht dem aktuellen Dienstplan!
      </span>
      <span class="text-secondary">
        Klicke rechts auf Löschen um die Umleitung zu entfernen.
        <span *ngIf="!today?.onDuty?.users?.length" class="text-alert-red"> Achtung, es existiert <a class="underline text-alert-red-dark" routerLink="/roster">kein Dienstplan für heute!</a></span>
      </span>
    </div>
    <div class="self-center">
      <button (click)="deleteCurrentOverwrite()" class="tkd-icon-btn tkd-primary">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
      </button>
    </div>
  </div>
</div>

<ng-template #noOverwrite>
  <div class="flex flex-row items-start" *ngIf="today?.onDuty?.users?.length; else: noRosterOrOverwrite">
    <nz-avatar nzIcon="user" nzShape="circle" [nzSize]="56" class="rounded-full shadow" [nzSrc]="today.onDuty.users[0].avatar"></nz-avatar>
    <div class="flex flex-col flex-grow justify-start ml-4">
      <span class="font-semibold text-primary">{{ today.onDuty.users[0].fullname }}</span> 
      <span class="text-secondary">
        Anrufe werden <a routerLink="/roster" class="underline text-highlight">laut Dienstplan</a> zugestellt.
      </span>
    </div>
  </div>

  <ng-template #noRosterOrOverwrite>
    <div class="flex flex-row items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="p-2 w-14 h-14 text-white rounded-full shadow bg-alert-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
      <span class="ml-4 font-semibold text-alert-red">
        Es ist momentan <a class="underline" routerLink="/roster">kein Dienstplan</a> und keine Umleitung eingestellt, <br>
        Anrufe <u>außerhalb der Öffnungszeiten</u> können derzeit nicht zugestellt werden!
      </span>
    </div>
  </ng-template>
</ng-template>

<div class="mb-12 tkd-card" [class.ready]="overwriteType !== '' && !!from && !!to">
  <header class="flex flex-row items-center px-12 py-12">
    <div class="flex-grow">
      <h1 class="mb-1 text-xl font-lato">Telefon umleiten</h1>
      <h2 class="text-sm">Hier kannst du den bestehenden <a class="text-highlight hover:underline"
          routerLink="/roster">Dienstplan</a> überschreiben bzw das Notruf-Telefon umleiten.</h2>
    </div>
    <svg xmlns="http://www.w3.org/2000/svg" class="mr-6 w-16 h-16 text-opacity-30 text-deEmphasized" fill="none"
      viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M21 3l-6 6m0 0V4m0 5h5M5 3a2 2 0 00-2 2v1c0 8.284 6.716 15 15 15h1a2 2 0 002-2v-3.28a1 1 0 00-.684-.948l-4.493-1.498a1 1 0 00-1.21.502l-1.13 2.257a11.042 11.042 0 01-5.516-5.517l2.257-1.128a1 1 0 00.502-1.21L9.228 3.683A1 1 0 008.279 3H5z" />
    </svg>
  </header>

  <div class="p-12 space-y-8">
    <section class="space-y-4">
      <div>
        <h2 class="text-lg font-semibold text-primary font-lato">1. Wähle den Zeitraum</h2>
        <span class="text-sm text-secondary">In welchem Zeitraum möchstest du den Dienstplan überschreiben und das
          Notruf-Telefon umleiten?</span>
      </div>

      <div class="flex justify-between">
        <div class="block mr-3 w-56">
          <nz-select [(ngModel)]="overwriteType" (ngModelChange)="onDateChange()" class="w-full">
            <nz-option nzValue="day-shift" nzLabel="Tag-Bereitschaft"></nz-option>
            <nz-option nzValue="night-shift" nzLabel="Nacht-Bereitschaft"></nz-option>
            <nz-option nzValue="both" nzLabel="Tag und Nacht Bereitschaft"></nz-option>
            <nz-option nzValue="custom" nzLabel="Beliebig"></nz-option>
          </nz-select>
        </div>

        <div class="flex-grow items-center" *ngIf="overwriteType !== ''">
          <!-- Custom Overwrite Date/Time Range -->
          <ng-container *ngIf="overwriteType === 'custom'; else: dateSelector">
            <div class="date-time">
              <span class="inline-block w-10 text-center">Von</span>
              <nz-date-picker name="from" [(ngModel)]="from" (ngModelChange)="onDateChange()"
                [nzDisabledDate]="disabledStartDate" [nzAllowClear]="false"></nz-date-picker>
              <nz-time-picker nzFormat="HH:mm" [(ngModel)]="from" nzS (ngModelChange)="onDateChange()" [nzAddOn]="quickTimeSelectFrom"
                [nzMinuteStep]="15" [nzAllowEmpty]="false"></nz-time-picker>
            </div>
            <div class="date-time">
              <span class="inline-block w-10 text-center">Bis</span>
              <nz-date-picker name="to" [(ngModel)]="to" (ngModelChange)="onDateChange()"
                [nzDisabledDate]="disabledEndDate" [nzAllowClear]="false"></nz-date-picker>
              <nz-time-picker nzFormat="HH:mm" [(ngModel)]="to" (ngModelChange)="onDateChange()" [nzMinuteStep]="15"
                [nzAllowEmpty]="false"></nz-time-picker>
            </div>

            <ng-template #quickTimeSelectFrom>
              <button class="tkd-btn tkd-small tkd-primary">Tagdienst</button>
              <button class="tkd-btn tkd-small tkd-primary">Nachtdienst</button>
            </ng-template>
          </ng-container>

          <!-- Quick Select Day/Night shift -->
          <ng-template #dateSelector>
            <span class="inline-block w-10 text-center">vom</span>
            <nz-date-picker [(ngModel)]="from" (ngModelChange)="onDateChange()" [nzDisabledDate]="isBeforeRosterDate"
              [nzAllowClear]="false"></nz-date-picker>

            <svg xmlns="http://www.w3.org/2000/svg" class="inline w-5 h-5 text-deEmphasized" viewBox="0 0 20 20"
              fill="currentColor" [nz-tooltip]="tooltipTemplate">
              <path fill-rule="evenodd"
                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z"
                clip-rule="evenodd" />
            </svg>

            <ng-template #tooltipTemplate>
              Von {{actualBoundary?.from | date:'medium'}} <br />
              Bis {{actualBoundary?.to | date:'medium'}}
            </ng-template>
          </ng-template>
        </div>
      </div>

      <!-- User avatars for day/night on-duty on the selected date -->
      <nz-avatar-group class="current-state" *ngIf="!!stateForDate">
        <ng-container
          *ngIf="(overwriteType === 'both' || overwriteType === 'day-shift') && stateForDate.plannedDay?.length">
          <ng-container *ngFor="let user of stateForDate.plannedDay; trackBy: trackProfile">
            <nz-avatar [nz-tooltip]="user.fullname + ' - Tag Bereitschaft'" nzIcon="user" nzShape="circle"
              [nzSrc]="user.avatar"></nz-avatar>
          </ng-container>
        </ng-container>
        <ng-container
          *ngIf="overwriteType === 'both' || overwriteType === 'night-shift' || !stateForDate.plannedDay?.length">
          <ng-container *ngFor="let user of stateForDate.plannedNight; trackBy: trackProfile">
            <nz-avatar
              [nz-tooltip]="user.fullname + ' - ' + (stateForDate.plannedDay?.length ? 'Nacht' : 'Tag/Nacht') +  ' Bereitschaft'"
              nzIcon="user" nzShape="circle" [nzSrc]="user.avatar"></nz-avatar>
          </ng-container>
        </ng-container>
      </nz-avatar-group>

      <!-- List of overlapping overwrites -->
      <div *ngIf="overlapping?.length" class="p-4 text-white rounded border shadow bg-alert-red border-alert-red-dark" [@scaleInOut]>
        <div class="mb-2">
          <h2 class="text-base text-white underline">Überlappende Einträge gefunden</h2>
          <span class="text-sm">
            Es existieren bereits Überschreibungen/Umleitungen für den angegebenen Zeitraum. Bitte überprüfe den
            Zeitraum oder lösche notfalls die bestehenden Umleitungen:
          </span>
        </div>
        <ul class="mx-4">
          <li *ngFor="let ov of overlapping"
            class="flex flex-col-reverse items-start p-2 space-x-4 border-b border-white border-opacity-20 md:items-center md:flex-row">
            <div class="hidden flex-col justify-around items-center md:flex">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                  d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                  clip-rule="evenodd" />
              </svg>
            </div>
            <div class="flex flex-row justify-evenly text-xs md:flex-col">
              <span>{{ ov.from | date:"short" }}</span>
              <span class="inline-block mx-2 md:hidden">bis</span>
              <span>{{ ov.to | date:"short" }}</span>
            </div>
            <div class="flex relative flex-row flex-grow items-center self-stretch space-x-2">
              <ng-container *ngIf="ov.user; else: noUserTemplate">
                <nz-avatar nzIcon="user" nzShape="circle" [nzSrc]="ov.user.avatar"></nz-avatar>
                <div>
                  {{ ov.user.fullname }}
                </div>
              </ng-container>
              <ng-template #noUserTemplate>
                <span>{{ ov.displayName || ov.phoneNumber }}</span>
                <span>{{ ov.phoneNumber }}</span>
              </ng-template>

              <button class="inline-block absolute right-2 md:hidden tkd-icon-btn-inverse tkd-danger no-shadow" (click)="deleteOverwrite(ov)">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
              </div>
            <button class="hidden mr-4 md:inline-block tkd-icon-btn-inverse tkd-danger no-shadow" (click)="deleteOverwrite(ov)">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </li>
        </ul>
      </div>

    </section>


    <section [class.ready]="!!selectedUser || !!selectedQuickTargetNumber || !!customPhoneNumber" class="space-y-4">
      <div>
        <h2 class="text-lg font-semibold text-primary font-lato">2. Wähle das neue Ziel</h2>
        <span class="text-sm text-secondary">Wähle die Person beziehungsweise das Umleitungsziel für den angegebenen
          Zeitraum.</span>
      </div>

      <div class="user-list">
        <div *ngFor="let setting of quickSettings; trackBy: trackQuickSetting" class="quick-setting"
          [class.selected]="setting.TargetNumber === selectedQuickTargetNumber" (click)="selectQuickSetting(setting)">
          <nz-avatar nzIcon="number" nzShape="circle"></nz-avatar>
          <div>
            <span class="name">{{ setting.DisplayName }}</span>
            <span class="number">{{ setting.TargetNumber }}</span>
          </div>
        </div>
      </div>
      <div class="user-list">

        <div *ngFor="let user of preferredUsers; trackBy: trackProfile" class="user" (click)="selectUser(user.name)"
          [class.selected]="user.name === selectedUser">
          <nz-avatar nzIcon="user" nzShape="circle" [nzSrc]="user.avatar"></nz-avatar>
          <span>{{ user.fullname }}</span>
        </div>

        <ng-container *ngIf="showAllUsers">
          <div *ngFor="let user of otherAllowedUsers; trackBy: trackProfile" class="user"
            (click)="selectUser(user.name)" [class.selected]="user.name === selectedUser">
            <nz-avatar nzIcon="user" nzShape="circle" [nzSrc]="user.avatar"></nz-avatar>
            <span>{{ user.fullname }}</span>
          </div>
        </ng-container>
      </div>
      <label *ngIf="otherAllowedUsers.length" nz-checkbox [(ngModel)]="showAllUsers">Alle anzeigen</label>
      <div class="user-list" *ngIf="allowPhone">
        <nz-input-group nzAddOnBefore="oder Telefonnummer">
          <input type="text" nz-input placeholder="+43 1234 1234" [(ngModel)]="customPhoneNumber"
            (ngModelChange)="onCustomPhoneNumberChange()" />
        </nz-input-group>
      </div>
    </section>

    <div class="actions">
      <button class="text-sm uppercase font-lato tkd-btn tkd-primary" (click)="createOverwrite()"
        [disabled]="!valid">Umleiten</button>
    </div>
  </div>
</div>

<!-- Dialogs and modals -->
<ng-template #confirmDeleteCurrentOverwrite>
  Möchtest du die Umleitung für {{ today?.actualUser?.fullname || today?.actual?.phoneNumber}} wirklich löschen?
  <br />
  <ng-container *ngIf="today.onDuty?.users?.length; else: noRosterTemplate">
    Anrufe werden dann laut Dienstplan an <span class="underline text-highlight">{{ today.onDuty.users[0].fullname }}</span> weitergeleitet.
  </ng-container>
  <ng-template #noRosterTemplate>
    <span class="text-alert-red">Es ist keine Dienstplan für heute konfiguriert, wenn die Umleitung gelöscht wird <u>können Anrufe nicht zugestellt werden!</u></span>
  </ng-template>
</ng-template>
