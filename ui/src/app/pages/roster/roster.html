<div class="flex w-full py-3 -mb-3 space-x-3">
  <div class="flex-grow">
    <nz-alert *ngIf="showNoRosterAlert && !editMode" [nzMessage]="noRosterAlertTemplate" nzType="warning">
    </nz-alert>
  </div>

  <ng-template #noRosterAlertTemplate>
    <span>
      <i class="warning-sign" nz-icon nzType="warning" nzTheme="outline"></i>
      Es konnte kein Dienstplan für {{ selectedDate.toLocaleString('default', { month: 'long' }) }} {{
      selectedDate.getFullYear() }} gefunden werden!
    </span>
  </ng-template>

  <div class="flex-row justify-between space-x-1">
    <ng-container *ngIf="layout.isPhone">
      <button class="tkd-icon-btn tkd-secondary" (click)="today()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
      </button>

      <button class="tkd-icon-btn tkd-primary" (click)="prevMonth()" nzType="primary">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <button class="tkd-icon-btn tkd-primary" (click)="nextMonth()" nzType="primary">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>

    </ng-container>

    <button class="tkd-icon-btn tkd-primary" *ngIf="canEditRoster && !editMode && !readonly" (click)="toggleEdit()"
      nzTooltipTitle="Dienstplan bearbeiten" nz-tooltip>
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        <path
          d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
      </svg>
    </button>

    <button class="tkd-icon-btn tkd-primary" *ngIf="canEditRoster && (editMode || saveLoading)" (click)="toggleEdit()"
      nzTooltipTitle="Dienstplan speichern" nz-tooltip>
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        <path
          d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" />
      </svg>
    </button>

    <button class="tkd-icon-btn tkd-danger" *ngIf="canEditRoster && editMode" nz-popconfirm
      nzPopconfirmTitle="Änderungen verwerfen?" nzPopconfirmPlacement="bottom" (nzOnConfirm)="discardChanges()"
      nzTooltipTitle="Änderunge verwerfen" nz-tooltip>
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd"
          d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
          clip-rule="evenodd" />
      </svg>
    </button>

    <button class="tkd-icon-btn tkd-danger" nz-popconfirm *ngIf="canEditRoster && !editMode && !readonly"
      nzTooltipTitle="Dienstplan löschen" nz-tooltip nzPopconfirmTitle="Dienstplan sicher löschen?"
      nzPopconfirmPlacement="bottom" (nzOnConfirm)="deleteRoster()">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd"
          d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
          clip-rule="evenodd" />
      </svg>
    </button>

    <nz-badge [nzCount]="comments.length">
      <button class="tkd-icon-btn tkd-secondary" (click)="toggleComments()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd"
            d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z"
            clip-rule="evenodd" />
        </svg>
      </button>
    </nz-badge>
  </div>
</div>

<nz-calendar (nzPanelChange)="onPanelChange($event)" (nzSelectChange)="onDateSelected($event)"
  *ngIf="layout.isTabletLandscapeUp; else mobileViewTemplate" class="p-1 rounded shadow-md sm:p-4 md:p-8">
  <ul *nzDateFullCell="let date" [class.other-month]="date.getMonth() !== selectedDate.getMonth()"
    (click)="selectRosterDay(date)" nz-button nz-dropdown
    [(nzVisible)]="getVisibleProp(date.toLocaleString())[date.toLocaleString()]" [nzClickHide]="false"
    [nzDropdownMenu]="readonly ? null: userMenu" nzTrigger="click" class="selected-users"
    [class.holiday]="!!holidays[date.toDateString()]" [class.highlight-active]="!!highlightUser"
    [class.highlight-day]="shouldHighlightDay(date)">

    <span style="padding-right: 2px; overflow: hidden; white-space: nowrap;">
      <nz-tag *ngIf="!!holidays[date.toDateString()]; else: showDayTemplate" nzColor="geekblue" class="holiday-tag">
        <span class="date">{{date.getDate()}}</span>
        <span class="name">
          &nbsp;{{holidays[date.toDateString()].localName}}
        </span>
      </nz-tag>

      <ng-template #showDayTemplate>
        {{date.getDate()}}
      </ng-template>
    </span>

    <ng-container
      *ngTemplateOutlet="userDutyTemplate; context: {$implicit: getDay(date).forenoon, hasOfficeHours: openingHours[date.toDateString()]?.hasForenoon}">
    </ng-container>
    <ng-container
      *ngTemplateOutlet="userDutyTemplate; context: {$implicit: getDay(date).afternoon, hasOfficeHours: openingHours[date.toDateString()]?.hasAfternoon}">
    </ng-container>
    <ng-container
      *ngTemplateOutlet="userDutyTemplate; context: {$implicit: getDay(date).onCall.day, hasOfficeHours: true}">
    </ng-container>
    <ng-container
      *ngTemplateOutlet="userDutyTemplate; context: {$implicit: getDay(date).onCall.night, hasOfficeHours: true}">
    </ng-container>

    <ng-template #userDutyTemplate let-set let-hasOfficeHours="hasOfficeHours">
      <li>
        <ng-template [ngIf]="hasOfficeHours || set?.length > 0">
          <span class="user-tag" *ngFor="let user of set" nz-tooltip [nzTooltipTitle]="userProfiles[user]?.fullname"
            [class.highlight-user]="highlightUser === user" [style.backgroundColor]="userProfiles[user]?.color"
            [style.color]="userProfiles[user]?.fontColor" (mouseenter)="highlightUserSubject.next(user)"
            (mouseleave)="highlightUserSubject.next('')">
            {{ userProfiles[user]?.fullname.slice(0, 2) || 'N/A' }}
          </span>
        </ng-template>
      </li>
    </ng-template>
  </ul>
</nz-calendar>

<ng-template #mobileViewTemplate>
  <div class="mobile-view">
    <div class="day content-section" *ngFor="let date of dates" [attr.id]="date.toDateString()"
      [class.highlight-active]="!!highlightUser" [class.highlight-day]="shouldHighlightDay(date)"
      [class.today]="date.toDateString() === selectedDate?.toDateString()">
      <h3>
        {{ weekdays[date.getDay()] }}, {{ date.toLocaleDateString() }}
      </h3>
      <div class="selection-row">
        <span class="title">Vormittag</span>
        <ng-container *ngTemplateOutlet="mobileUserDutyTemplate; context: {$implicit: getDay(date).forenoon}">
        </ng-container>
      </div>
      <div class="selection-row">
        <span class="title">Nachmittag</span>
        <ng-container *ngTemplateOutlet="mobileUserDutyTemplate; context: {$implicit: getDay(date).afternoon}">
        </ng-container>
      </div>
      <div class="selection-row">
        <span class="title">Tag Bereitschaft </span>
        <ng-container *ngTemplateOutlet="mobileUserDutyTemplate; context: {$implicit: getDay(date).onCall.day}">
        </ng-container>
      </div>
      <div class="selection-row">
        <span class="title">Nacht Bereitschaft</span>
        <ng-container *ngTemplateOutlet="mobileUserDutyTemplate; context: {$implicit: getDay(date).onCall.night}">
        </ng-container>
      </div>
    </div>

    <ng-template #mobileUserDutyTemplate let-day>
      <span class="user-tag" *ngFor="let user of day" [class.highlight-user]="highlightUser === user"
        [style.backgroundColor]="userProfiles[user]?.color" [style.color]="userProfiles[user]?.fontColor"
        (mouseenter)="highlightUserSubject.next(user)" (mouseleave)="highlightUserSubject.next('')">
        {{ userProfiles[user]?.fullname || 'N/A' }}
      </span>
    </ng-template>
  </div>
</ng-template>

<nz-dropdown-menu #userMenu="nzDropdownMenu">
  <div *ngIf="!!selectedDay" nz-menu class="user-menu">
    <ng-template [ngIf]="openingHours[selectedDate.toDateString()]?.hasForenoon">
      <ng-container *ngTemplateOutlet="userSelection; context: {$implicit: 'forenoon', title: 'Vormittag'}">
      </ng-container>
    </ng-template>
    <ng-template [ngIf]="openingHours[selectedDate.toDateString()]?.hasAfternoon">
      <ng-container *ngTemplateOutlet="userSelection; context: {$implicit: 'afternoon', title: 'Nachmittag'}">
      </ng-container>
    </ng-template>

    <ng-container *ngIf="differentOnCallDay || onCallIsDifferent">
      <ng-container
        *ngTemplateOutlet="userSelectionOnCall; context: {$implicit: 'day', title: 'Tag Bereitschaft', placeholder: 'Bitte auswählen, sonst gleich wie Nacht-Bereitschaft'}">
      </ng-container>
    </ng-container>

    <ng-container *ngTemplateOutlet="userSelectionOnCall; context: {$implicit: 'night', title: 'Nacht Bereitschaft'}">
    </ng-container>

    <div class="flex flex-row justify-end w-full p-3 space-x-3">
      <button class="tkd-btn tkd-small tkd-secondary" *ngIf="editMode && !(differentOnCallDay || onCallIsDifferent)" (click)="differentOnCallDay = true">
        <span>Tag Bereitschaftsdienst hinzufügen</span>
      </button>

      <button *ngIf="canEditRoster && !editMode && !readonly" class="tkd-btn tkd-small tkd-secondary"
        (click)="toggleEdit()">
        <i nz-icon nzType="edit" nzTheme="outline"></i>
        <span>Bearbeiten</span>
      </button>

      <button class="tkd-btn tkd-small tkd-tertiary" (click)="closeDropdown()" nzType="default">
        <i nz-icon nzType="close" nzTheme="outline"></i>
        <span>Schließen</span>
      </button>
    </div>

    <ng-template #userSelection let-model let-title="title">
      <div class="selection-row">
        <span nz-menu-group class="title">{{title}}</span>
        <nz-select *ngIf="editMode && isDropDownVisible" [(ngModel)]="selectedDay[model]" nzMode="multiple"
          (ngModelChange)="rosterChanged()" nzPlaceHolder="Bitte auswählen">
          <nz-option *ngFor="let option of selectableUserNames" [nzLabel]="userProfiles[option]?.fullname"
            [nzValue]="option">
          </nz-option>
        </nz-select>
        <div *ngIf="!editMode" class="selected-users">
          <li><span *ngFor="let username of selectedDay[model]"
              class="user-tag">{{userProfiles[username]?.fullname}}</span></li>
        </div>
      </div>
    </ng-template>

    <ng-template #userSelectionOnCall let-model let-placeholder="placeholder" let-title="title">
      <div class="selection-row">
        <span nz-menu-group class="title">{{title}}</span>
        <nz-select *ngIf="editMode && isDropDownVisible" [(ngModel)]="selectedDay.onCall[model]" nzMode="multiple"
          (ngModelChange)="rosterChanged()" [nzPlaceHolder]="placeholder || 'Bitte auswählen'">
          <nz-option *ngFor="let option of selectableUserNames" [nzLabel]="userProfiles[option]?.fullname"
            [nzValue]="option">
          </nz-option>
        </nz-select>
        <div *ngIf="!editMode" class="selected-users">
          <li><span *ngFor="let username of selectedDay.onCall[model]"
              class="user-tag">{{userProfiles[username]?.fullname}}</span></li>
        </div>
      </div>
    </ng-template>
  </div>
</nz-dropdown-menu>

<nz-drawer [nzClosable]="true" [nzVisible]="showComments" nzPlacement="right" (nzOnClose)="toggleComments()"
  [nzWidth]="layout.isPhone ? '100vw' : layout.isDesktopUp ? '25vw' : '50vw'">
  <ng-template [nzDrawerContent]>
    <div class="comment-container">
      <h2>Kommentare</h2>

      <app-comment *ngFor="let comment of comments" [comment]="comment" (replied)="loadComments()" [nestedLimit]="2">
      </app-comment>

      <div class="create-comment-container">
        <h3>Erstelle einen neuen Kommentar:</h3>
        <app-text-input format="markdown" [(ngModel)]="newComment"></app-text-input>
        <button class="tkd-btn tkd-primary" (click)="createComment()">Kommentieren</button>
      </div>
    </div>
  </ng-template>
</nz-drawer>
