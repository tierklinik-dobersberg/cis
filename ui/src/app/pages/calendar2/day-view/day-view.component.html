<ng-template [headerCell]="calendarType" #defaultHeaderCell="tkdCalendarHeaderCell" let-calendar>
  {{ calendar.name }}
</ng-template>

<ng-template [eventCell]="calendarType" #defaultEventCell="tkdCalendarEventCell" let-event>
  {{ event.id }}
</ng-template>

<header class="z-50 flex-grow-0 flex-shrink-0 w-full grid-container">
  @for (cal of data; track trackCalendar($index, cal)) {
    <div>
      <ng-container
      *ngTemplateOutlet="
        headerCell?.template || defaultHeaderCell.template;
        context: {
          $implicit: cal
        }
      "
    ></ng-container>
  </div>
}
</header>

<div class="overflow-auto relative flex-grow" #calendarContainer (scroll)="handleScroll($event)">
  <div
    class="w-full grid-container"
    [style.height]="24 * 3600 | secondsToPixel : sizeFactor"
    >
    @for (cal of data; track trackCalendar($index, cal)) {
      <div
        #container
        (click)="handleCalendarClick($event, cal, container, false)"
        (dblclick)="handleCalendarClick($event, cal, container, true)"
        class="relative h-full"
        [attr.calendar-id]="cal.id"
        >
        @for (h of hours; track h; let last = $last) {
          <div
            [attr.hour]="h"
            class="absolute w-full text-xs border-t border-opacity-50 border-primary p-2"
        [ngClass]="{
          'border-b-8 border-b-primary-dark': last
        }"
        [ngStyle]="{
        top: ((h * 60 * 60) | secondsToPixel: sizeFactor) + 'px',
        height: ((60 * 60) | secondsToPixel: sizeFactor) + 'px',
     }"
            >
            {{ h }}:00
          </div>
        }
        @if (cal.events | sort | eventStyle : sizeFactor : min; as events) {
          @for (event of events | sort; track event.id) {
            <div
              class="absolute transition duration-150 ease-in-out overflow-visible"
          [ngClass]="{
            'hover:!z-[100]': !event.ignoreOverlapping
          }"
              [attr.event-id]="event.id"
              [ngStyle]="$any(event).style"
              >
              <ng-container
            *ngTemplateOutlet="
                eventCell?.template || defaultEventCell.template;
                context: {
                    $implicit: $any(event),
                    calendar: cal,
                }
            "
              >
            </ng-container>
          </div>
        }
      }
    </div>
  }
</div>

<!-- Current Time Marker -->
@if (showCurrentTime) {
  <div
    class="absolute right-0 left-0 border-t border-alert-red z-[100] drop-shadow"
    [style.top.px]="currentTime$ | async | secondsToPixel : sizeFactor"
    >
    <span
      class="absolute top-0 right-0 px-1 py-0.5 text-xs text-white rounded-b bg-alert-red"
      >
      {{ currentTime$ | async | time }}
    </span>
  </div>
}
</div>
