<span class="inline-block w-full mb-1 text-xs text-center rounded font-lato text-secondary"
  [ngClass]="{'bg-primary text-white':!!holiday}">{{ holiday?.localName}} {{ date | date:'dd.MM' }}</span>

<ul class="flex overflow-auto flex-col flex-grow gap-1 px-0.5 py-0.5 group" *ngIf="!isDisabledDate">
  <li *ngFor="let shift of requiredShifts" cdkOverlayOrigin #trigger="cdkOverlayOrigin"
    (contextmenu)="onContextMenu($event, trigger)" (click)="onShiftClick(trigger, shift)"
    [ngStyle]="{backgroundColor: shiftDefinitions[shift.shiftID]?.color + '40'}"
    class="flex overflow-hidden relative flex-row gap-1 justify-start items-center px-1.5 py-1 text-xs shadow-sm transition-all duration-200 ease-in-out cursor-pointer hover:ring-1 text-primary"
    [ngClass]="{'cursor-not-allowed opacity-40': !!selectedUser && !(selectedUser|inList:shift.eligibleStaff) && !(selectedUser|inList:assigned[shift.shiftID]), 'opacity-50': highlightUserShifts !== null && !(highlightUserShifts | inList:assigned[shift.shiftID]), 'ring-1': highlightUserShifts | inList:assigned[shift.shiftID], 'rounded': !trigger.elementRef.nativeElement.open, 'rounded-t ring-1 shadow-inner': trigger.elementRef.nativeElement.open }">

    <ng-container *ngIf="shiftDefinitions[shift.shiftID] as def">
      <div
        [nz-tooltip]="def.name + (def.description ? ': ' + def.description : '') + ' - Von ' + (shift.from | date:'HH:mm') + ' bis ' + (def.from|workShiftEnd:def.duration)"
        class="flex overflow-hidden flex-col justify-between pr-1.5 text-xs uppercase whitespace-nowrap border-r select-none text-ellipsis text-secondary font-lato"
        [ngStyle]="{borderColor: shiftDefinitions[shift.shiftID]?.color + 'aa'}" style="font-size: 0.65rem;">

        <span class="transition-all duration-200 ease-in-out translate-y-2 group-hover:translate-y-0"
          [class.font-semibold]="highlightUserShifts|inList:assigned[shift.shiftID]">
          {{ shift.shortName }}
        </span>

        <span class="transition-all duration-200 ease-in-out -translate-x-full group-hover:translate-x-0">
          {{ assigned[shift.shiftID]?.size || 0 }}/{{ shift.requiredStaffCount }}
        </span>
      </div>

      <span *ngIf="!!selectedUser && !(selectedUser|inList:shift.eligibleStaff)"
        class="absolute flex items-center justify-center w-4 h-4 text-white rounded-full top-3 right-3 bg-opacity-light bg-alert-red"
        [nz-tooltip]="violationTemplate">!</span>

      <ng-template #violationTemplate>
        <ul>
          <li *ngFor="let violation of shift.constraintViolations[selectedUser] | constraintViolation">
            {{ violation }}
          </li>
        </ul>
      </ng-template>

      <div class="flex flex-row flex-wrap items-center flex-grow gap-1">
        <div *ngFor="let user of assigned[shift.shiftID]">
          <span *ngIf="users[user] as profile" class="block px-0.5 rounded border border-subtle"
            [ngStyle]="{backgroundColor: profile.color + 'aa', color: profile.fontColor, borderColor: profile.color}">
            <span>{{ (profile.fullname || profile.name).substr(0, 2) }}</span>
          </span>
        </div>
      </div>

    </ng-container>

    <ng-template cdkConnectedOverlay [cdkConnectedOverlayOrigin]="trigger"
      [cdkConnectedOverlayOpen]="trigger.elementRef.nativeElement.open"
      (overlayOutsideClick)="onOverlayOutsideClick($event, trigger)">
      <ul class="p-2 bg-white rounded-b shadow w-80 ring-1">
        <li *ngFor="let user of shift.eligibleStaff">
          <div class="flex flex-row items-center gap-2 p-2 rounded cursor-pointer hover:bg-subtle"
            (click)="onShiftClick(trigger, shift, user)">

            <nz-avatar nzIcon="user" [nzSrc]="users[user].avatar"></nz-avatar>
            <div class="flex flex-col justify-start gap-1">
              <span>{{ users[user].fullname || user}}</span>
              <span class="text-xs leading-3 text-secondary" *ngIf="workTimeStatus[user] as work">
                <span [ngClass]="{'text-alert-red': work.expectedWorkTime < work.plannedWorkTime, 'text-alert-green-dark': work.expectedWorkTime > work.plannedWorkTime}">{{ work.plannedWorkTime | duration:'default-hours':'ms' }}</span>
                <span>/{{ work.expectedWorkTime | duration:'default-hours':'ms' }}</span>
              </span>
            </div>

            <div class="flex-grow"></div>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"
              *ngIf="user|inList:assigned[shift.shiftID]">
              <path fill-rule="evenodd"
                d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z"
                clip-rule="evenodd" />
            </svg>
          </div>
        </li>
      </ul>
    </ng-template>
  </li>
</ul>
