<!-- Header Row -->
<div class="flex flex-row items-center -mb-6 space-x-4" *ngIf="editMode">
  <img
    [attr.src]="preview"
    *ngIf="!!preview && !previewError; else: noUserAvatar"
    class="block w-12 h-12 bg-white rounded-full shadow text-color-primary"
    (error)="previewError = true"
  />
  <ng-template #noUserAvatar>
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="
        block
        p-2.5
        w-12
        h-12
        bg-white
        rounded-full
        shadow
        text-color-primary
      "
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
      />
    </svg>
  </ng-template>

  <div class="flex flex-col">
    <span class="text-base font-semibold font-lato text-primary">
      {{ fullname || name }}
    </span>
    <span class="text-secondary" *ngIf="!!fullname"> {{ name }} </span>
  </div>

  <div class="flex-grow"></div>

  <div class="flex flex-row space-x-3">
    <button class="tkd-icon-btn tkd-primary tkd-small" (click)="saveUser()">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        nz-tooltip="Speichern"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"
        />
      </svg>
    </button>
    <button
      class="cursor-not-allowed tkd-icon-btn tkd-danger tkd-small"
      nz-tooltip="Löschen wird noch nicht unterstützt"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
        />
      </svg>
    </button>
  </div>
</div>

<nz-tabset>
  <nz-tab nzTitle="Übersicht">
    <!-- User Data Forms -->
    <div class="flex space-x-4">
      <div class="flex flex-col flex-grow space-y-4 sm:space-y-6 md:space-y-8">
        <div class="tkd-card">
          <header>
            <h1>Allgemein</h1>
            <span>Allgemeine Daten zu den CIS Benutzer.</span>
          </header>

          <div class="space-y-8">
            <!-- Username -->
            <div class="flex flex-row space-x-4">
              <span
                class="text-2xl text-color-primary-dark font-lato"
                [class.text-opacity-light]="!name"
              >
                1.
              </span>
              <div class="flex flex-col flex-grow">
                <span class="text-base font-medium font-lato">
                  Benutzername <span class="text-color-primary-dark">*</span>
                </span>
                <span class="text-sm text-secondary font-lato">
                  Der Anmeldename für den Benutzer. Dieser Name kann
                  <u>nicht mehr geändert werden!</u>
                </span>
                <div class="mt-3" *ngIf="!editMode">
                  <input
                    type="text"
                    class="w-full xl:w-1/2 tkd-input"
                    [(ngModel)]="name"
                    nz-tooltip="Verwende nur Kleinbuchstaben damit man sich den Namen leicht merken kann"
                    nzTooltipPlacement="right"
                  />
                </div>
                <div class="mt-3" *ngIf="editMode">
                  <span class="text-base font-medium text-color-primary-dark"
                    >{{name}}</span
                  >
                </div>
              </div>
            </div>

            <!-- Full Name -->
            <div class="flex flex-row space-x-4">
              <span
                class="text-2xl text-color-primary-dark font-lato"
                [class.text-opacity-light]="!fullname"
              >
                2.
              </span>
              <div class="flex flex-col flex-grow">
                <span class="text-base font-medium font-lato">
                  Vor- und Nachname
                </span>
                <span class="text-sm text-secondary font-lato">
                  Der Vor und Nachname des Benutzers. Dieser wird im CIS
                  anstelle des Benutzernames angezeigt.
                </span>
                <div class="mt-3">
                  <input
                    type="text"
                    class="w-full xl:w-1/2 tkd-input"
                    [(ngModel)]="fullname"
                  />
                </div>
              </div>
            </div>

            <!-- Mail -->
            <div class="flex flex-row space-x-4">
              <span
                class="text-2xl text-color-primary-dark font-lato"
                [class.text-opacity-light]="!emailAddresses[0]"
              >
                3.
              </span>
              <div class="flex flex-col flex-grow">
                <span class="text-base font-medium font-lato"> E-Mail </span>
                <span class="text-sm text-secondary font-lato">
                  E-Mail Adressen des Benutzers. Es ist zumindest eine E-Mail
                  Adresse notwendig <br />damit Funktionen wie "Passwort
                  vergessen" funktionieren.
                </span>
                <tkd-string-slice-input
                  class="w-full mt-3 xl:w-1/2"
                  [(ngModel)]="emailAddresses"
                  tooltip="E-Mail Adresse hinzufügen"
                >
                </tkd-string-slice-input>
              </div>
            </div>

            <!-- Phonenumber -->
            <div class="flex flex-row space-x-4">
              <span
                class="text-2xl text-color-primary-dark font-lato"
                [class.text-opacity-light]="!phoneNumbers[0]"
              >
                4.
              </span>
              <div class="flex flex-col flex-grow">
                <span class="text-base font-medium font-lato"> Telefon </span>
                <span class="text-sm text-secondary font-lato">
                  Eine Telefonnummer für den Benutzer. Eine Telefonnummer ist
                  notwendig um <br />
                  2-Faktor-Authentifizierung (2FA) einzurichten.
                </span>
                <tkd-string-slice-input
                  class="w-full mt-3 xl:w-1/2"
                  [(ngModel)]="phoneNumbers"
                  tooltip="Telefonnummer hinzufügen"
                >
                </tkd-string-slice-input>
              </div>
            </div>
            <!-- User roles -->
            <div class="flex flex-row space-x-4">
              <span
                class="text-2xl text-color-primary-dark font-lato"
                [class.text-opacity-light]="!roles?.length"
              >
                5.
              </span>
              <div class="flex flex-col flex-grow">
                <span class="text-base font-medium font-lato"> Rollen </span>
                <span class="text-sm text-secondary font-lato">
                  Wähle die entsprechenden Rollen für den Bentuzer.
                </span>
                <nz-select
                  class="w-full mt-3 xl:w-1/2"
                  nzMode="multiple"
                  nzPlaceHolder="Please select"
                  [(ngModel)]="roles"
                >
                  <nz-option
                    *ngFor="let item of availableRoles"
                    [nzLabel]="item.name"
                    [nzValue]="item.name"
                    [nzCustomContent]="true"
                  >
                    <span
                      class="block w-full"
                      [nz-tooltip]="item.description"
                      nzTooltipPlacement="right"
                      >{{ item.name }}</span
                    >
                  </nz-option>
                </nz-select>
              </div>
            </div>
          </div>
        </div>

        <div class="tkd-card">
          <header>
            <h1>Kalender und Termine</h1>
            <span
              >Einstellungen die den Kalender, Termine und Dienstpläne
              betreffen</span
            >
          </header>
          <div
            class="grid items-start grid-cols-1 gap-4  md:gap-6 lg:gap-8 lg:grid-cols-2"
          >
            <div class="flex flex-row space-x-4">
              <span
                class="text-2xl text-color-primary-dark font-lato"
                [class.text-opacity-light]="!color"
              >
                6.
              </span>
              <div class="flex flex-col flex-grow">
                <span class="text-base font-medium font-lato">
                  Benutzer Farbe
                </span>
                <span class="text-sm text-secondary font-lato">
                  Eine eindeutige Farbe für den Benutzer.
                </span>
                <div class="flex items-center mt-3 space-x-2">
                  <color-twitter
                    class="inline-block"
                    triangle="hide"
                    [(ngModel)]="color"
                  ></color-twitter>
                  <span
                    class="inline-block w-8 h-8 rounded shadow"
                    [style.backgroundColor]="color"
                  ></span>
                </div>
              </div>
            </div>

            <div class="flex flex-row space-x-4">
              <span
                class="text-2xl text-color-primary-dark font-lato"
                [class.text-opacity-light]="!calendar && !createCalendar"
              >
                7.
              </span>
              <div class="flex flex-col flex-grow">
                <span class="text-base font-medium font-lato">
                  Termin Kalender
                </span>
                <span class="text-sm text-secondary font-lato">
                  Der Name des Google Kalenders für den Benutzer.
                </span>
                <div class="flex flex-col items-stretch mt-3 space-y-1">
                  <ng-container
                    *ngIf="availableCalendars !== null; else: calendarIntegrationDisabled"
                  >
                    <nz-select
                      [(ngModel)]="calendar"
                      [nzDisabled]="createCalendar"
                    >
                      <nz-option
                        *ngFor="let cal of availableCalendars"
                        [nzValue]="cal._id"
                        ,
                        [nzLabel]="cal.name"
                      >
                      </nz-option>
                    </nz-select>

                    <span class="space-x-2">
                      <span class="text-secondary">oder</span>
                      <label
                        nz-checkbox
                        [(ngModel)]="createCalendar"
                        nz-tooltip="Erstelle einen neuen Kalender für diesen Benutzer."
                        nzTooltipPlacement="right"
                      >
                        Kalender erstellen
                      </label>
                    </span>
                  </ng-container>
                  <ng-template #calendarIntegrationDisabled>
                    <span class="text-alert-red"
                      >Die Google Kalender Integration ist nicht
                      aktiviert.</span
                    >
                  </ng-template>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="tkd-card" *ngIf="userProperties.length > 0">
          <header>
            <h1>Zusätzliche Eigenschaften</h1>
            <span
              >Einstellungen die den Kalender, Termine und Dienstpläne
              betreffen</span
            >
          </header>
          <div
            class="grid items-start grid-cols-1 gap-4  md:gap-6 lg:gap-8 lg:grid-cols-2"
          >
            <tkd-option-spec-input
              *ngFor="let prop of userProperties; let index=index"
              [spec]="prop"
              [index]="index + 7"
              [(ngModel)]="properties[prop.name]"
            ></tkd-option-spec-input>
          </div>
        </div>

        <div class="tkd-card">
          <div class="flex flex-row items-center space-x-4">
            <span
              class="text-2xl text-color-primary-dark font-lato"
              [class.text-opacity-light]="!color"
              *ngIf="!editMode"
            >
              {{ 7 + userProperties.length }}.
            </span>
            <div
              class="flex flex-col items-center flex-grow  lg:justify-between lg:flex-row"
            >
              <div class="flex flex-col flex-grow">
                <span class="text-base font-medium font-lato">
                  Passwort {{ editMode ? ' ändern' : ''}}
                </span>
                <span class="text-sm text-secondary font-lato">
                  Wähle ein Passwort für den Benutzer. Andernfalls wird ein
                  zufälliges Passwort erstellt.
                </span>
              </div>
              <div class="flex flex-col items-end space-y-2">
                <button
                  class="tkd-btn tkd-primary tkd-outline h-fit"
                  (click)="showPasswordModal = true"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-6 h-6 mr-2"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    *ngIf="!!password"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 13l4 4L19 7"
                    />
                  </svg>
                  {{ !password ? editMode ? 'Passwort ändern' : 'Passwort setzen
                  ': 'Passwort gesetzt'}}
                </button>
                <label nz-checkbox [(ngModel)]="needsPasswortChange"
                  >Erzwinge eine Änderung des Passworts</label
                >
              </div>
            </div>
          </div>
        </div>

        <div class="tkd-card" *ngIf="!editMode">
          <header class="flex flex-row items-center justify-between">
            <div>
              <h1>Benutzer anlegen</h1>
              <span
                >Alles fertig? Wenn du bereit bist kannst du den Benutzer
                erstellen.</span
              >
            </div>
            <div>
              <button
                class="text-sm tkd-btn tkd-primary font-lato"
                (click)="createUser()"
                [disabled]="!name && !fullname"
                [nz-tooltip]="!name && !fullname ? 'Benutzername und Vor- bzw Nachname ist erforderlich' : ''"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-6 h-6 mr-2"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"
                  />
                </svg>
                Benutzer erstellen
              </button>
            </div>
          </header>
        </div>
      </div>

      <!-- User Avatar -->
      <div class="flex-shrink-0 w-1/3" *ngIf="!editMode">
        <label
          for="file-upload"
          [class.h-96]="!preview"
          class="flex items-center justify-center p-4 text-xl border border-dashed rounded cursor-pointer  border-primary border-opacity-light text-color-primary font-lato hover:bg-primary hover:bg-opacity-5"
        >
          <img
            [attr.src]="preview"
            *ngIf="!!preview; else: noPreview"
            class="rounded"
          />
          <ng-template #noPreview> Avatar auswählen </ng-template>
        </label>
        <input
          id="file-upload"
          type="file"
          class="hidden"
          (change)="imagePreview($event)"
        />
      </div>
    </div>
  </nz-tab>

  <nz-tab nzTitle="Berechtigungen" [nzDisabled]="!editMode">
    <div class="tkd-card">
      <header>
        <h1>Berechtigungen</h1>
        <span>Verwalte direkte Benutzerberechtigungen.</span>
      </header>
      <div>
        <app-permissions-view [(ngModel)]="permissions"></app-permissions-view>
      </div>
    </div>
  </nz-tab>
</nz-tabset>

<!-- Select User Password Modal -->
<nz-modal
  [(nzVisible)]="showPasswordModal"
  nzTitle="Bestimme ein Passwort"
  (nzOnCancel)="handleCancel()"
>
  <div *nzModalContent class="space-y-2">
    <span class="inline-block mb-4">
      {{ !editMode ? 'Bestimme ein Passwort für den Benutzer.' + ' Wenn du auf
      "Abbrechen" klickst wird automatisch ein neues Passwort generiert.' :
      'Setze ein neues Passwort für den Benutzer.' }}
    </span>
    <input
      class="tkd-input"
      type="password"
      [(ngModel)]="passwordModal.password"
      (ngModelChange)="getPasswordStrength($event)"
      placeholder="Passwort eingeben"
    />
    <input
      class="tkd-input"
      type="password"
      [(ngModel)]="passwordModal.repeat"
      placeholder="Passwort wiederholen"
    />

    <span *ngIf="pwdStrength">
      Passwort Stärke:
      <span
        [nz-tooltip]="'Crack-Time: ' + pwdStrength.crackTime"
        [style.color]="pwdStrength.color"
        >{{ pwdStrength.text }}</span
      >
    </span>
  </div>

  <div *nzModalFooter class="flex flex-row justify-end space-x-2">
    <button class="tkd-btn tkd-primary tkd-outline" (click)="handleCancel()">
      Abbrechen
    </button>
    <button
      class="tkd-btn tkd-primary"
      [disabled]="!passwordModal.password || passwordModal.password !== passwordModal.repeat"
      (click)="handleOk()"
    >
      Speichern
    </button>
  </div>
</nz-modal>

<!-- Generated Password Modal -->
<nz-modal
  [(nzVisible)]="showGeneratedPasswordModal"
  nzTitle="Benutzer Passwort"
  (nzOnCancel)="handleGeneratedPasswordClose()"
>
  <div *nzModalContent class="space-y-2">
    <span class="inline-block mb-4">
      Bitte notiere dir folgendes Passwort. Es ist nicht möglich sich das
      Passwort erneut anzeigen zu lassen!
    </span>
    <input class="tkd-input" type="text" readonly [ngModel]="password" />
  </div>

  <div *nzModalFooter class="flex flex-row justify-end space-x-2">
    <button class="tkd-btn tkd-danger" (click)="handleGeneratedPasswordClose()">
      OK
    </button>
  </div>
</nz-modal>
